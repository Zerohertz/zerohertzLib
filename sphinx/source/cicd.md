# CI/CD Pipelines

```{admonition} Used Stacks
:class: important

GitHub Actions (Black, flake8, Pylint, Setuptools, PyTest, Sphinx)
```

## Branch Rules

### Dev Branch

```{admonition} Branch Rule
:class: note

The `dev` branch is used when there are functional changes resulting in different build outcomes.
```

<p align="center">
   <img width="872" alt="dev-branch" src="_static/cicd/github-actions-dev-branch.png">
</p>

1. `dev-*` push
   1. `check-pr`: Check if a PR is open for the `dev-*` branch
   2. `build`: Install dependencies & build package
   3. `lint`: Check format of python codes
   4. `test`: Do PyTest
2. `dev-*` → `master`
   1. `check-commit`: Commit message parsing
   2. `build`: Install dependencies & build package
   3. `lint`: Check format of python codes
   4. `test`: Do PyTest
   5. `docs`: Create PR (`docs` → `dev-*`) including the build results generated by Sphinx
   6. `merge-from-docs`: If merge PR from `docs`, can merge `dev-*` → `master`
3. `master` push
   1. `build`: Install dependencies & build package
   2. `deploy`
      1. `GitHub`: Deploy to GitHub
      2. `PyPI`: Deploy to PyPI

### Chore Branch

```{admonition} Branch Rule
:class: note

The `chore` branch is utilized when the build result is not different, but there are changes in the CI/CD pipeline or documentation.
```

<p align="center">
   <img width="872" alt="chore-branch" src="_static/cicd/github-actions-chore-branch.png">
</p>

1. `chore-*` push
2. `chore-*` → `master`
   1. `check-commit`: Commit message parsing
   2. `build`: Install dependencies & build package
   3. `lint`: Check format of python codes
   4. `test`: Do PyTest
   5. `docs`: Create PR (`docs` → `dev-*`) including the build results generated by Sphinx
   6. `merge-from-docs`: If merge PR from `docs`, can merge `dev-*` → `master`
3. `master` push

## Managing Labels for Issues and Pull Requests in GitHub

+ [Issue](https://github.com/Zerohertz/zerohertzLib/blob/master/.github/workflows/issue-controller.yaml)
  + `assignees: ['Zerohertz']`
  + `contains(github.event.issue.title, '[Bug]')` → `labels: ['fix']`
  + `contains(github.event.issue.title, '[Chore]')` → `labels: ['chore']`
  + `contains(github.event.issue.title, '[Style]')` → `labels: ['style']`
  + `contains(github.event.issue.title, '[Docs]')` → `labels: ['docs']`
+ [Pull Request](https://github.com/Zerohertz/zerohertzLib/blob/master/.github/workflows/pr-controller.yaml)
  + `assignees: ['Zerohertz']`
  + `body.includes('bug') || body.includes('fix') || body.includes('수정')` → `labelsToAdd.push('fix')`
  + `body.includes('style')` → `labelsToAdd.push('style')`
  + `baseBranch === 'master' && headBranch.startsWith('dev')`
    + `labelsToAdd.push('release')`
    + `(file.filename.startsWith('Jenkins') || file.filename.startsWith('.github/workflows'))` → `labelsToAdd.push('chore')`
    + `(file.filename.startsWith('sphinx') && !file.filename.includes('release'))` → `labelsToAdd.push('docs')`
    + `(file.filename.startsWith('zerohertzLib/{MODULE_NAME}/__init__') || body.includes('{MODULE_NAME}'))` → `labelsToAdd.push('feat/{MODULE_NAME}')`
  + `baseBranch === 'master' && headBranch.startsWith('chore')`
    + `labelsToAdd.push('release/chore')`
    + `(file.filename.startsWith('Jenkins') || file.filename.startsWith('.github/workflows'))` → `labelsToAdd.push('chore')`
    + `(file.filename.startsWith('sphinx') && !file.filename.includes('release'))` → `labelsToAdd.push('docs')`
  + `baseBranch.startsWith('dev') || baseBranch.startsWith('chore')) && headBranch === 'docs'`
    + `labelsToAdd.push('docs')`

## Sphinx Documentation Deployment

```{admonition} Sphinx Documentation
:class: note

Documents created and built using Sphinx are deployed via GitHub Actions and GitHub Pages
```

<p align="center">
   <img width="872" alt="pages-build-and-deployment" src="_static/cicd/pages-build-and-deployment.png">
</p>

---

<details>
<summary>
Jenkins (Deprecated)
</summary>

```{admonition} Used Stacks
:class: important

Jenkins (Black, flake8, Pylint, Setuptools, PyTest, Sphinx)
```

<p align="center">
    <img width="1844" alt="CI/CD" src="_static/cicd/jenkins-cicd.png">
</p>

<h2>Jenkins</h2>

|Stage|Condition|
|:-:|-|
|1. `Setup`|⭕ [`*` Push]|
|2. `Merge From Docs`|⭕ [`*` Push] "Merge pull request\*/docs"</br>⭕ [`*` Push] "Merge pull request*[Docs] Build by Sphinx for GitHub Pages"|
|3. `1. Lint`|⭕ [`dev*` Push]<br>⭕ [`master` PR] (Except "Merge pull request\*/docs" && "Merge pull request\*[Docs] Build by Sphinx for GitHub Pages")|
|4. `2. Build`|⭕ [`master` Push] (Except "Merge pull request\*/chore\*")</br>⭕ [`dev*` Push]<br>⭕ [`master` PR] (Except "Merge pull request\*/docs" && "Merge pull request\*[Docs] Build by Sphinx for GitHub Pages")|
|5. `3. Test`|⭕ [`dev*` Push]<br>⭕ [`master` PR] (Except "Merge pull request\*/docs" && "Merge pull request\*[Docs] Build by Sphinx for GitHub Pages")|
|6. `4. Docs`|⭕ [`master` PR] (Except "Merge pull request\*/docs" && "Merge pull request\*[Docs] Build by Sphinx for GitHub Pages")|
|7. `Deploy`|⭕ [`master` Push] "Merge pull request\*from Zerohertz/dev\*" (Except "\*from Zerohertz/chore\*")|

<h3>Dev Branch</h3>

```{admonition} Branch Rule
:class: note

The `dev` branch is used when there are functional changes resulting in different build outcomes.
```

<p align="center">
   <img width="872" alt="dev-branch" src="_static/cicd/jenkins-dev-branch.png">
</p>

1. `dev-*` push
   1. `Setup`: Commit message parsing
   2. `1. Lint`: Check format of python codes
   3. `2. Build`: Install dependencies & build package
   4. `3. Test`: Do PyTest
2. `dev-*` → `master`
   1. `Setup`: Commit message parsing
   2. `1. Lint`: Check format of python codes
   3. `2. Build`: Install dependencies & build package
   4. `3. Test`: Do PyTest
   5. `4. Docs`: Create PR (`docs` → `dev-*`) including the build results generated by Sphinx
   6. `Merge From Docs`: If merge PR from `docs`, can merge `dev-*` → `master`
3. `master` push
   1. `Setup`: Commit message parsing
   2. `2. Build`: Install dependencies & build package
   3. `Deploy`
      1. `GitHub`: Deploy to GitHub
      2. `PyPI`: Deploy to PyPI

<h3>Chore Branch</h3>

```{admonition} Branch Rule
:class: note

The `chore` branch is utilized when the build result is not different, but there are changes in the CI/CD pipeline or documentation.
```

<p align="center">
   <img width="872" alt="chore-branch" src="_static/cicd/jenkins-chore-branch.png">
</p>

1. `chore-*` push
   1. `Setup`: Commit message parsing
2. `chore-*` → `master`
   1. `Setup`: Commit message parsing
   2. `1. Lint`: Check format of python codes
   3. `2. Build`: Install dependencies & build package
   4. `3. Test`: Do PyTest
   5. `4. Docs`: Create PR (`docs` → `chore-*`) including the build results generated by Sphinx
   6. `Merge From Docs`: If merge PR from `docs`, can merge `chore-*` → `master`
3. `master` push
   1. `Setup`: Commit message parsing

</details>
