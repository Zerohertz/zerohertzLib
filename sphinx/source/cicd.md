# CI/CD Pipelines

```{admonition} Used Stacks
:class: important

1. Jenkins (Black, Setuptools, PyTest, Sphinx)
2. GitHub Actions
```

## Jenkins

<p align="center">
    <img width="1844" alt="CI/CD" src="https://github-production-user-asset-6210df.s3.amazonaws.com/42334717/284097735-f7893be3-1e0f-4124-b22e-1e56dbc4f585.png">
</p>

|Stage|Condition|
|:-:|-|
|1. `Setup`|⭕ [`*` Push]|
|2. `Merge From Docs`|⭕ [`*` Push] "Merge pull request\*/docs"</br>⭕ [`*` Push] "Merge pull request*[Docs] Build by Sphinx for GitHub Pages"|
|3. `1. Lint`|⭕ [`dev*` Push]<br>⭕ [`master` PR] (Except "Merge pull request\*/docs" && "Merge pull request\*[Docs] Build by Sphinx for GitHub Pages")|
|4. `2. Build`|⭕ [`master` Push] (Except "Merge pull request\*/chore\*")</br>⭕ [`dev*` Push]<br>⭕ [`master` PR] (Except "Merge pull request\*/docs" && "Merge pull request\*[Docs] Build by Sphinx for GitHub Pages")|
|5. `3. Test`|⭕ [`dev*` Push]<br>⭕ [`master` PR] (Except "Merge pull request\*/docs" && "Merge pull request\*[Docs] Build by Sphinx for GitHub Pages")|
|6. `4. Docs`|⭕ [`master` PR] (Except "Merge pull request\*/docs" && "Merge pull request\*[Docs] Build by Sphinx for GitHub Pages")|
|7. `Deploy`|⭕ [`master` Push] (Except "Merge pull request\*/chore\*")|

### Dev Branch

```{admonition} Branch Rule
:class: note

The `dev` branch is used when there are functional changes resulting in different build outcomes.
```

<p align="center">
   <img width="872" alt="dev-branch" src="https://github-production-user-asset-6210df.s3.amazonaws.com/42334717/284097739-895d55da-2812-44c8-8d5e-0f632b43a83a.png">
</p>

1. `dev-*` push
   1. `Setup`: Commit message parsing
   2. `1. Lint`: Check format of python codes
   3. `2. Build`: Install dependencies & build package
   4. `3. Test`: Do PyTest
2. `dev-*` → `master`
   1. `Setup`: Commit message parsing
   2. `1. Lint`: Check format of python codes
   3. `2. Build`: Install dependencies & build package
   4. `3. Test`: Do PyTest
   5. `4. Docs`: Create PR (`docs` → `dev-*`) including the build results generated by Sphinx
   6. `Merge From Docs`: If merge PR from `docs`, can merge `dev-*` → `master`
3. `master` push
   1. `Setup`: Commit message parsing
   2. `2. Build`: Install dependencies & build package
   3. `Deploy`
      1. `GitHub`: Deploy to GitHub
      2. `PyPI`: Deploy to PyPI

### Chore Branch

```{admonition} Branch Rule
:class: note

The `chore` branch is utilized when the build result is not different, but there are changes in the CI/CD pipeline or documentation.
```

<p align="center">
   <img width="872" alt="dev-branch" src="https://github-production-user-asset-6210df.s3.amazonaws.com/42334717/284097744-66dfa600-5f44-4500-9171-326000588d74.png">
</p>

1. `chore-*` push
   1. `Setup`: Commit message parsing
2. `chore-*` → `master`
   1. `Setup`: Commit message parsing
   2. `1. Lint`: Check format of python codes
   3. `2. Build`: Install dependencies & build package
   4. `3. Test`: Do PyTest
   5. `4. Docs`: Create PR (`docs` → `chore-*`) including the build results generated by Sphinx
   6. `Merge From Docs`: If merge PR from `docs`, can merge `chore-*` → `master`
3. `master` push
   1. `Setup`: Commit message parsing

## GitHub Actions

### Managing Labels for Issues and Pull Requests in GitHub

+ [Issue](https://github.com/Zerohertz/zerohertzLib/blob/master/.github/workflows/issue-controller.yaml)
  + `assignees: ['Zerohertz']`
  + `contains(github.event.issue.title, '[Bug]')` → `labels: ['fix']`
  + `contains(github.event.issue.title, '[Chore]')` → `labels: ['chore']`
  + `contains(github.event.issue.title, '[Style]')` → `labels: ['style']`
  + `contains(github.event.issue.title, '[Docs]')` → `labels: ['docs']`
+ [Pull Request](https://github.com/Zerohertz/zerohertzLib/blob/master/.github/workflows/pr-controller.yaml)
  + `assignees: ['Zerohertz']`
  + `baseBranch === 'master' && headBranch.startsWith('dev')`
    + `labelsToAdd.push('release')`
    + `(file.filename.startsWith('Jenkins') || file.filename.startsWith('.github/workflows'))` → `labelsToAdd.push('chore')`
    + `file.filename.startsWith('sphinx')` → `labelsToAdd.push('docs')`
    + `file.filename.startsWith('zerohertzLib/algorithm/'` → `labelsToAdd.push('feat/algorithm')`
    + `file.filename.startsWith('zerohertzLib/api/'` → `labelsToAdd.push('feat/api')`
    + `file.filename.startsWith('zerohertzLib/mlops/'` → `labelsToAdd.push('feat/mlops')`
    + `file.filename.startsWith('zerohertzLib/plot/'` → `labelsToAdd.push('feat/plot')`
    + `file.filename.startsWith('zerohertzLib/util/'` → `labelsToAdd.push('feat/util')`
    + `file.filename.startsWith('zerohertzLib/vision/'` → `labelsToAdd.push('feat/vision')`
  + `baseBranch === 'master' && headBranch.startsWith('chore')`
    + `labelsToAdd.push('release/chore')`
    + `file.filename.startsWith('Jenkins') || file.filename.startsWith('.github/workflows')` → `labelsToAdd.push('chore')`
    + `file.filename.startsWith('sphinx') || file.filename.startsWith('.github/workflows')` → `labelsToAdd.push('docs')`
  + `baseBranch.startsWith('dev') || baseBranch.startsWith('chore')) && headBranch === 'docs'`
    + `labelsToAdd.push('docs')`

### Sphinx Documentation Deployment

```{admonition} Branch Rule
:class: note

Documents created and built using Sphinx are deployed via GitHub Actions and GitHub Pages
```

<p align="center">
   <img width="872" alt="pages-build-and-deployment" src="https://github-production-user-asset-6210df.s3.amazonaws.com/42334717/284098708-158ea625-5bba-4b5b-8f9e-d7cb72b880f0.png">
</p>
